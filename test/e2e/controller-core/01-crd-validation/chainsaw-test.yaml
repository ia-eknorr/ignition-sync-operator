apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: crd-validation
spec:
  description: Verify CRDs are installed and schema validation rejects invalid resources
  steps:
    - name: Assert Stoker CRD exists and is established
      try:
        - assert:
            timeout: 10s
            resource:
              apiVersion: apiextensions.k8s.io/v1
              kind: CustomResourceDefinition
              metadata:
                name: stokers.stoker.io
              status:
                conditions:
                  - type: Established
                    status: "True"

    - name: Assert SyncProfile CRD exists and is established
      try:
        - assert:
            timeout: 10s
            resource:
              apiVersion: apiextensions.k8s.io/v1
              kind: CustomResourceDefinition
              metadata:
                name: syncprofiles.stoker.io
              status:
                conditions:
                  - type: Established
                    status: "True"

    - name: Reject Stoker CR missing spec.git
      try:
        - apply:
            expect:
              - check:
                  ($error != null): true
            resource:
              apiVersion: stoker.io/v1alpha1
              kind: Stoker
              metadata:
                name: test-invalid
              spec:
                gateway:
                  port: 8088
                  apiKeySecretRef:
                    name: some-secret
                    key: apiKey
